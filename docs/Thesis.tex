% A LaTeX template for ARTICLE version of the MSc Thesis submissions to 
% Politecnico di Milano (PoliMi) - School of Industrial and Information Engineering
%
% S. Bonetti, A. Gruttadauria, G. Mescolini, A. Zingaro
% e-mail: template-tesi-ingind@polimi.it
%
% Last Revision: October 2021
%
% Copyright 2021 Politecnico di Milano, Italy. Inc. NC-BY

\documentclass[12pt,a4paper]{article} 

%------------------------------------------------------------------------------
%	REQUIRED PACKAGES AND  CONFIGURATIONS
%------------------------------------------------------------------------------
% PACKAGES FOR TITLES
\usepackage{titlesec}
\usepackage{color}

% PACKAGES FOR LANGUAGE AND FONT
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage[T1]{fontenc} % Font encoding

% PACKAGES FOR IMAGES
\usepackage{graphicx}
\graphicspath{{Images/}}
\usepackage{eso-pic} % For the background picture on the title page
\usepackage{subfig} % Numbered and caption subfigures using \subfloat
\usepackage{caption} % Coloured captions
\usepackage{transparent}

% STANDARD MATH PACKAGES
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{bm}
\usepackage[overload]{empheq}  % For braced-style systems of equations

% PACKAGES FOR TABLES
\usepackage{tabularx}
\usepackage{longtable} % tables that can span several pages
\usepackage{colortbl}

% PACKAGES FOR ALGORITHMS (PSEUDO-CODE)
\usepackage{algorithm}
\usepackage{algorithmic}

% PACKAGES FOR REFERENCES & BIBLIOGRAPHY
\usepackage[colorlinks=true,linkcolor=black,anchorcolor=black,citecolor=black,filecolor=black,menucolor=black,runcolor=black,urlcolor=black]{hyperref} % Adds clickable links at references
\usepackage{cleveref}
\usepackage[square, numbers, sort&compress]{natbib} % Square brackets, citing references with numbers, citations sorted by appearance in the text and compressed
\bibliographystyle{plain} % You may use a different style adapted to your field

% PACKAGES FOR THE APPENDIX
\usepackage{appendix}

% PACKAGES FOR ITEMIZE & ENUMERATES 
\usepackage{enumitem}

% OTHER PACKAGES
\usepackage{amsthm,thmtools,xcolor} % Coloured "Theorem"
\usepackage{comment} % Comment part of code
\usepackage{fancyhdr} % Fancy headers and footers
\usepackage{lipsum} % Insert dummy text
\usepackage{tcolorbox} % Create coloured boxes (e.g. the one for the key-words)

\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{bm}
\usepackage[overload]{empheq} % For braced-style systems of equations.
\usepackage{fix-cm} % To override original LaTeX restrictions on sizes
\usepackage{siunitx}

\usepackage{minted}

%-------------------------------------------------------------------------
%	NEW COMMANDS DEFINED
%-------------------------------------------------------------------------
% EXAMPLES OF NEW COMMANDS -> here you see how to define new commands
\newcommand{\bea}{\begin{eqnarray}} % Shortcut for equation arrays
\newcommand{\eea}{\end{eqnarray}}
\newcommand{\e}[1]{\times 10^{#1}}  % Powers of 10 notation
\newcommand{\mathbbm}[1]{\text{\usefont{U}{bbm}{m}{n}#1}} % From mathbbm.sty
\newcommand{\pdev}[2]{\frac{\partial#1}{\partial#2}}
% NB: you can also override some existing commands with the keyword \renewcommand

%----------------------------------------------------------------------------
%	ADD YOUR PACKAGES (be careful of package interaction)
%----------------------------------------------------------------------------


%----------------------------------------------------------------------------
%	ADD YOUR DEFINITIONS AND COMMANDS (be careful of existing commands)
%----------------------------------------------------------------------------


% Do not change Configuration_files/config.tex file unless you really know what you are doing. 
% This file ends the configuration procedures (e.g. customizing commands, definition of new commands)
\input{Configuration_files/config}

% Insert here the info that will be displayed into your Title page 
% -> title of your work
\renewcommand{\title}{Homework Report}
% -> author name and surname
\renewcommand{\author}{Giovanni Versiglioni}
% -> MSc course
\newcommand{\course}{Computer Science and Engineering}
% -> advisor name and surname
%\newcommand{\advisor}{Prof. Name Surname}
% IF AND ONLY IF you need to modify the co-supervisors you also have to modify the file Configuration_files/title_page.tex (ONLY where it is marked)
%\newcommand{\firstcoadvisor}{Name Surname} % insert if any otherwise comment
%\newcommand{\secondcoadvisor}{Name Surname} % insert if any otherwise comment
% -> author ID
\newcommand{\ID}{11015537}
% -> academic year
\newcommand{\YEAR}{2023-2024}
% -> abstract (only in English)
\renewcommand{\abstract}{}

% -> key-words (only in English)
\newcommand{\keywords}{here, the keywords, of your thesis}

\counterwithin{figure}{section}

% DOCUMENT START
\begin{document}

\nocite{bookCV}

\input{Configuration_files/title_page}

\setcounter{section}{-1}

\tableofcontents
\listoffigures

\large

\section{Introduction}
\label{sec:introduction}
This is the report for the Image Analysis and Computer Vision Homework, A.Y. 2023-2024.\\

\textbf{Scene (Figure \ref{fig:cylinder}).} A right circular cylinder together with two circular cross sections and two generatrix lines. A right circular cylinder is a surface, made of parallel lines, which is
symmetric about a symmetry axis. A circular cross section of a right cylinder is a circumference
centered on the symmetry axis and perpendicular to the symmetry axis. A generatrix line is a
straight line, on the cylinder surface, which is parallel to its axis.\\

\textbf{Image (Figure \ref{fig:palazzoTe}).} A single image is taken of the described cylinder by an uncalibrated, zero-skew camera. Two circular cross sections are visible, and their images $C_1,C_2$ are extracted. Two (parallel) generatrix lines of the cylinder are also visible, and their images $l_1,l_2$ are extracted.

\begin{figure}[H]
    \centering
    \subfloat[Scene -- Right circular cylinder with two cross sections and two generatrix lines.\label{fig:cylinder}]{
        \includegraphics[width=0.47\textwidth]{Images/Cylinder.png}
    }
    \quad
    \subfloat[Image -- Cylindrical voult in Palazzo Te, Mantova, Italy.\label{fig:palazzoTe}]{
        \includegraphics[width=0.47\textwidth]{Images/PalazzoTe.png}
    }
    \caption[Homework problem formulation and image data.]{Homework problem formulation and image data.}
    \label{fig:problem}
\end{figure}

\section{Feature Extraction}
\label{sec:featureExtraction}
The goal is to retrieve geometrical data -- such as edges, corners, and lines -- from the given image.

\subsection{Edge Detection}
\label{sec:edgeDetection}
The \textbf{Canny} method can be used to detect edges in the image.\\

The algorithm comprises the following sequential steps:
\begin{itemize}
    \item[(i)] Apply Gaussian filter to smooth the image in order to remove the noise;
    \item[(ii)] Find the intensity gradients of the image;
    \item[(iii)] Apply gradient magnitude thresholding or lower bound cut-off suppression to get rid of spurious response to edge detection;
    \item[(iv)] Apply double threshold to determine potential edges;
    \item[(v)] Track edges by hysteresis: finalize the detection of edges by suppressing all the other edges that are weak and not connected to strong edges.
\end{itemize}
\bigskip
MATLAB already includes (in the Image Processing Toolbox) an implementation of this method in the \verb|edge| function, which has been used in the \linebreak \verb|detectEdges.m| script. \textbf{Figure \ref{fig:edges}} shows the resulting image.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.83\textwidth]{Images/PalazzoTe_edges.png}
    \caption[Edge Detection.]{Edge Detection.}
    \label{fig:edges}
\end{figure}

\subsection{Corner Detection}
\label{sec:cornerDetection}
The \textbf{Harris} method can be used to detect corners in the image.\\

The algorithm comprises the following sequential steps:
\begin{itemize}
    \item[(i)] Color to gray-scale in order to work on a single channel and enhancing speed processing;
    \item[(ii)] Spatial derivative calculation to highlight pattern changes around each pixel region analyzed and then setting up the tensor structure;
    \item[(iii)] Harris response calculation by computing the smallest approximated eigenvalue of the structure tensor;
    \item[(iv)] Non-maximum suppression in order to pick up the optimal values to indicate corners -- find the local maxima as corners within the window which is a 3 by 3 filter.
\end{itemize}
\bigskip
The function \verb|findCorners.m| implements this method and is used in the \linebreak \verb|detectCorners.m| script to compute corners in the image. \textbf{Figure \ref{fig:corners}} shows the resulting image.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.83\textwidth]{Images/PalazzoTe_corners.png}
    \caption[Corner Detection.]{Corner Detection.}
    \label{fig:corners}
\end{figure}

\subsection{Line Detection}
\label{sec:lineDetection}
The \textbf{Hough Transform} method can be used to detect lines in the image.\\

The algorithm comprises the following steps:
\begin{itemize}
    \item[(i)] Edge detection: using the Canny edge detector;
    \item[(ii)] Mapping of edge points to the Hough space and storage in an accumulator;
    \item[(iii)] Interpretation of the accumulator to yield lines of infinite length. The interpretation is done by thresholding and possibly other constraints;
    \item[(iv)] Conversion of infinite lines to finite lines based on the hyper-parameters setting.
\end{itemize}
\bigskip
The function \verb|findLines.m| implements this method and is used in the \verb|detectLines.m| script to compute lines in the image. \textbf{Figure \ref{fig:lines}} shows the resulting image.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.83\textwidth]{Images/PalazzoTe_lines.png}
    \caption[Line Detection.]{Line Detection.}
    \label{fig:lines}
\end{figure}

\section{Rectification}
\label{sec:reconstruction}
This section comprises two main parts. The first part presents theoretical results to Problems 1-5 computed in MATLAB. In the second part will be carried out the metric rectification of a cylindrical surface. Specifically, the unfolding of the part of the surface included between two cross section will be reconstructed onto a plane.

\subsection{Problems}
\label{sec:problems}
The script \verb|Problems.m| contains all the proceedings and results of the following theoretical problems:
\begin{enumerate}
    \item From $C_1,C_2$ find the horizon (vanishing) line $h$ of the plane orthogonal to the cylinder axis.
    \item From $l_1,l_2,C_1,C_2$ find the image projection $a$ of the cylinder axis, and its vanishing point $V$.
    \item From $l_1,l_2,C_1,C_2$ (and possibly $h,a,V$) find the calibration matrix K.
    \item From $h,K,V$ determine the orientation of the cylinder axis w.r.t. the camera reference.
    \item Compute the ratio between the radius of the circular cross sections ans their distance.
\end{enumerate}
\bigskip
The very first step is to read the image, convert it to gray-scale, and convert it to double precision -- using functions provided by MATLAB such as \verb|imread|, \verb|rgb2gray|, and \verb|im2double|.

\subsubsection{Cross Sections and Generatrix Lines Identification, Image Contour}\label{sec:toImageContour}
The images of the circular cross sections are conics. Since in Euclidean and projective geometry five points determine a conic, it is possible to scatter five points belonging to any of the cross sections in the image scene and then fit the conic through them. To draw the five points, it is possible to use any of the vaults in the image as a reference.\\

Using the equation of a conic in Cartesian coordinates (Equation \ref{eq:conic}), it is possible to retrieve the (six) parameters by which it is identified and store them in the homogeneous conic coefficients matrix (\ref{eq:conicMatrix}).

\begin{equation}
    aX^2+bXY+cY^2+dX+eY+f=0
    \label{eq:conic}
\end{equation}

\begin{equation}
    C =
    \begin{bmatrix}
    a & b/2 & d/2\\
    b/2 & c & e/2\\
    d/2 & e/2 & f
    \end{bmatrix}
    \label{eq:conicMatrix}
\end{equation}
\bigskip

To find a generatrix line it suffices to compute the line through any two points laying on the two cross sections identified. In homogeneous coordinates this amounts to the cross product of the two points.\\

Now -- using the parameters identified -- it is possible to plot the image contour (i.e. the two cross sections and the two generatrix lines), as shown in \textbf{Figure \ref{fig:contour}}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{Images/PalazzoTe_contour.png}
    \caption[Image Contour -- Cross sections and generatrix lines.]{Image Contour -- Cross sections (blue) and generatrix lines (red).}
    \label{fig:contour}
\end{figure}

\subsubsection{Circular Points Image, Vanishing Line}\label{sec:toVanishingLine}
Two conics always intersect in four distinct points in projective geometry. Looking at the two identified cross sections shown in \textbf{Figure \ref{fig:contour}}, it is clear that there are two real intersections and two complex conjugate intersections -- that are exactly the image of circular points.\\

The vanishing line is the line through the image of circular points, and (again) in homogeneous coordinates this amounts to the cross product of the two points.\\

Since the vanishing line equation is computed in homogeneous coordinates, in order to plot the line in the image it is first necessary to convert it in Cartesian coordinates. This can be accomplished by dividing the line vector (in homogeneous coordinates) by the third component. Finally, the line is plotted in the image, as shown in \textbf{Figure \ref{fig:vanishingLine}}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.67\textwidth]{Images/PalazzoTe_vanishing_line.png}
    \caption[Vanishing Line.]{Vanishing Line (green).}
    \label{fig:vanishingLine}
\end{figure}

\subsubsection{Diameters, Centres, Cylinder Axis Image and Vanishing Point}\label{sec:toAxisImageVanishingPoint}
The diameters are computed multiplying the conics' coefficients matrices with the image of the circular points (two diameters computed per conic).\\

For any conic (i.e. image of circular cross section), the intersection point between the two diameters is the center. In homogeneous coordinates this amounts to the cross product of the two lines (i.e. diameters).\\

To retrieve the image of the cylinder axis it suffices to determine the line through the centres of the two cross sections. The outcome is shown in \textbf{Figure \ref{fig:axisImage}}\\

The vanishing point of a given line is the direction (i.e. point at infinity) of the line in the plane. Algebraically, given a line in homogeneous coordinates, it is obtained intersecting it with the canonical line at infinity.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.67\textwidth]{Images/PalazzoTe_axis.png}
    \caption[Cylinder Axis Image.]{Cylinder axis image (cyan).}
    \label{fig:axisImage}
\end{figure}

\subsubsection{Calibration Matrix, Cylinder Axis Orientation, Radius-Distance Ratio}\label{sec:toRatioRadiusDistance}
In this section, the calibration matrix $K$ -- containing the intrinsic parameters of the camera --  will be computed. In the assignment is stated that the skew factor is null, thus there are four unknowns. Therefore, to estimate the calibration matrix -- using the Image of the Absolute Conic (IAC) -- four constraints (i.e. equations) are necessary. The IAC is strongly related to the camera calibration matrix through the following Equation \ref{eq:iacCalib}.

\begin{equation}
    \omega = (KK^T)^{-1}
    \label{eq:iacCalib}
\end{equation}
\bigskip

In order to compute the IAC -- using the function \verb|get_IAC| -- three vanishing points were determined, one vertical and two horizontal with respect to the given image. The vertical vanishing point has been computed intersecting (using the cross product) two vertical parallel lines (green lines in \textbf{Figure \ref{fig:calibConstraints}}). To find the two horizontal vanishing points, two pairs of parallel lines relying on a horizontal plane were considered (red lines in \textbf{Figure \ref{fig:calibConstraints}}).\\

Using the two horizontal vanishing points, one can compute the image of the line at infinity orthogonal to the vertical vanishing point. This allows to have two constraints with the same equation, because it would be completely equivalent to have two separate constraints using orthogonal vanishing points alone. The other two constraints can be easily recovered exploiting the transformation matrix $H = [h_1,h_2,h_3]$ combined with the image of the circular points $h_1 \pm ih_2$.\\

Hence, the four constraints (three equations) are reported in the following system \ref{eq:calibSystem}.

\begin{equation}
    \begin{cases}
        l'_\infty = \omega v\\
        h_1^T\omega h_2 = 0\\
        h_1^T\omega h_1 - h_2^T\omega h_2 = 0
    \end{cases}
    \label{eq:calibSystem}
\end{equation}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.83\textwidth]{Images/PalazzoTe_IAC_constraints.png}
    \caption[Calibration constraints.]{Calibration constraints.}
    \label{fig:calibConstraints}
\end{figure}

Finally, one can compute the calibration matrix $K$ through Cholesky Decomposition of the IAC. The obtained calibration matrix is presented in the following Equation \ref{eq:calibrationMatrix}, where $f_x,f_y,U_0,V_0$ are the camera intrinsic parameters.

\begin{equation}
    K =
    \begin{bmatrix}
    f_x & 0 & U_0\\
    0 & f_y & V_0\\
    0 & 0 & 1
    \end{bmatrix}
    \approx 10^3
    \begin{bmatrix}
    2.2753 & 0 & 1.0161\\
    0 & 3.8887 & 4.0102\\
    0 & 0 & 1
    \end{bmatrix}
    \label{eq:calibrationMatrix}
\end{equation}
\bigskip

Using the estimated calibration matrix, the cylinder axis with respect to the camera reference is computed, and the ratio between the radius of the circular cross sections and their distance is determined using points and centres of the conics.

\subsection{Metric Rectification}
\label{sec:shapeReconstruction}
The objective is to metric rectify (i.e. 2D reconstruct) the unfolding of the part of the cylinder surface included between the two cross sections onto a plane.\\

Metric rectification will be accomplished using images of circles \cite{MetRecCircles}. Specifically, three images of circles will be used, as shown in \textbf{Figure \ref{fig:recConics}}. To determine the parameters of the selected conics, the same method used to estimate the cross sections has been used.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{Images/PalazzoTe_rec_conics.png}
    \caption[Circles Images used for rectification.]{Circles Images used for rectification.}
    \label{fig:recConics}
\end{figure}

Then, for every pair of conics the intersections are computed. In order to disambiguate between the solutions the image of the circular points is determined as the mean one among the ones computed.\\

Next, the line at infinity is computed using the image of the conic dual to the circular points -- that is determined using the definition.\\

The affine rectification matrix is evaluated using the line at infinity, as shown in Equation \ref{eq:hMatrix}.

\begin{equation}
    H = 
    \begin{bmatrix}
    1 & 0 & 0\\
    0 & 1 & 0\\
    & {l'_\infty}^T &
    \end{bmatrix}
    \label{eq:hMatrix}
\end{equation}
\bigskip

At this point, taken one of the three conics (e.g. $C_1$) its projective transformation in the rectified plane is obtained applying the rule stated in Equation \ref{eq:qMatrix}.

\begin{equation}
    Q = H^{-T}C_1H^{-1}
    \label{eq:qMatrix}
\end{equation}
\bigskip

Using implemented MATLAB function \verb|AtoG| one can extract geometric information about the conic on the rectified plane (i.e. $Q$) from its (known) parameters.

\begin{minted}{matlab}
par_geo = AtoG([Q(1,1),2*Q(1,2),Q(2,2),2*Q(1,3),2*Q(2,3),Q(3,3)]);
center = par_geo(1:2);
axes = par_geo(3:4);
alpha = par_geo(5);
\end{minted}

To compute the affinity that rectifies the cylinder, the idea is to make the one that makes the axis of the ellipses to be equal (i.e. maps the conic in the image onto a circle in the rectified image). To do this, the desired affinity is obtained combining a rotation -- using rotation matrix $U$ defined in Equation \ref{eq:uMatrix} -- and a scaling -- using diagonal matrix $S$ defined in Equation \ref{eq:sMatrix}, which rescales the axis to be unitary.\\

\begin{equation}
    U = 
    \begin{bmatrix}
    cos(\alpha) & -sin(\alpha)\\
    sin(\alpha) & cos(\alpha)
    \end{bmatrix}
    \label{eq:uMatrix}
\end{equation}
\bigskip
\begin{equation}
    S = 
    \begin{bmatrix}
    1 & 0\\
    0 & a/b
    \end{bmatrix}
    \label{eq:sMatrix}
\end{equation}
\bigskip

The final steps -- reported by \ref{eq:kMatrix}, \ref{eq:aMatrix}, \ref{eq:tMatrix} -- result in the final mapping $T$.

\begin{equation}
    K = USU^T
    \label{eq:kMatrix}
\end{equation}

\begin{equation}
    A = 
    \begin{bmatrix}
    K & 0_{2x1}\\
    0_{1x2} & 1
    \end{bmatrix}
    \label{eq:aMatrix}
\end{equation}

\begin{equation}
    T = AH
    \label{eq:tMatrix}
\end{equation}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{Images/PalazzoTe_rectified.png}
    \caption[Rectified cylinder surface between two generatrix lines.]{Rectified cylinder surface between two generatrix lines.}
    \label{fig:rectified}
\end{figure}

\pagebreak

\normalsize

\section*{Matlab Functions}

\begin{minted}{matlab}
function [corner_x, corner_y] = findCorners(I, sigma, border_margin)
    dx = [-1 0 1; 
          -1 0 1; 
          -1 0 1];
    dy = dx';
    Ix = conv2(I, dx, 'same');
    Iy = conv2(I, dy, 'same');
    g = fspecial('gaussian', max(1,fix(3*sigma)+1), sigma);
    Ix2 = conv2(Ix.^2, g, 'same');
    Iy2 = conv2(Iy.^2, g, 'same');
    Ixy = conv2(Ix.*Iy, g, 'same');
    cm = (Ix2.*Iy2 - Ixy.^2)./(Ix2 + Iy2 + eps);
    cm(1:border_margin,:) = 0;
    cm(end-border_margin:end,:) = 0;
    cm(:,end-border_margin:end) = 0;
    cm(:,1:border_margin) = 0;
    T = mean(cm(:));
    CIM = cm;
    CIM(cm<T) = 0;
    support = true(11);
    maxima = ordfilt2(CIM, sum(support(:)), support);
    [corner_x, corner_y] = find((cm==maxima).*(CIM>0));
end
\end{minted}

\begin{minted}{matlab}
function lines = findLines(I)
    edges = edge(I, 'canny', [0.2 0.25]);
    [H,T,R] = hough(edges, 'RhoResolution', 0.5, 'Theta', -90:0.5:89.5);
    P = houghpeaks(H, 50, 'threshold', ceil(0.3*max(H(:))), 'NHoodSize', [97 37]);
    lines = houghlines(edges, T, R, P, 'FillGap', 200, 'MinLength', 500);
end
\end{minted}

\begin{minted}{matlab}
function [l] = segToLine(pts)
    a = [pts(1,:)';1];
    b = [pts(2,:)';1];
    l = cross(a,b);
    l = l./norm(l);
end
\end{minted}

\begin{minted}{matlab}
function IAC = get_IAC(l_infs, vps, vp1s, vp2s, H)
% Returns the Image of the absolute conic
% Full code in '2 - Rectification/Functions'
end
\end{minted}

\begin{minted}{matlab}
function [ParG,code] = AtoG(ParA)
% Conversion of algebraic parameters to geometric parameters
% ParG = [Center(1:2), Axes(1:2), Angle]'
% Full code in '2 - Rectification/Functions'
end
\end{minted}

\pagebreak

\large

\bibliography{bibliography.bib}

\end{document}
% DOUMENT END
